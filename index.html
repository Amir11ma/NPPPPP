<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ÙˆØ¶Ø¹ÛŒØª Ø¢Ø¨ Ùˆ Ù‡ÙˆØ§ Ø§ÛŒØ±Ø§Ù† </title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/font-face.min.css">

<style>
  :root{
    --bg:#f4f8fc;
    --card:#ffffff;
    --muted:#6b7785;
    --accent:#ff9800;
    --accent-600:#fb8c00;
    --radius:14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family: Vazirmatn, "Tahoma", sans-serif;background:var(--bg);color:#0b1a2b;-webkit-font-smoothing:antialiased}
  header{
    background: linear-gradient(90deg,var(--accent),#ffb74d);
    color:#fff;padding:18px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px;
    box-shadow: 0 6px 20px rgba(0,0,0,.12);
    position: sticky; top: 0; z-index: 40;
  }
  header .title{font-size:18px;font-weight:700;margin:0}
  header .subtitle{font-size:13px;opacity:.95}
  main{max-width:980px;margin:14px auto;padding:14px}
  .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:14px}
  .btn{
    background:var(--accent);color:#fff;border:0;padding:9px 12px;border-radius:10px;font-weight:600;cursor:pointer;
    box-shadow: 0 6px 14px rgba(0,0,0,.08);
  }
  .btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(0,0,0,.06);box-shadow:none}
  .select, .search{
    background:var(--card);border-radius:10px;padding:6px 8px;border:1px solid #e9eef6;min-width:120px;
  }
  .search input{border:0;outline:none;padding:8px;width:220px;background:transparent;font-size:14px}
  .row{
    display:grid;grid-template-columns:1fr 280px;gap:14px;
  }
  .list{display:grid;gap:12px}
  .card{
    background:var(--card);border-radius:var(--radius);padding:12px;display:flex;align-items:center;gap:12px;
    box-shadow: 0 6px 18px rgba(12,30,60,.04);
  }
  .card .left{flex:1}
  .city{font-size:16px;font-weight:700;margin-bottom:4px}
  .meta{font-size:13px;color:var(--muted)}
  .aqi{
    min-width:84px;text-align:center;border-radius:10px;padding:10px 8px;background:linear-gradient(180deg,#f6f8fb,#ffffff);
    box-shadow: inset 0 -6px 18px rgba(0,0,0,.02);
  }
  .aqi .val{font-size:20px;font-weight:800}
  .aqi .emoji{font-size:24px;margin-top:6px;display:block;animation: float 2s infinite ease-in-out}
  @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
  .change{font-size:13px;color:var(--muted);margin-top:6px}
  .panel{
    background:linear-gradient(180deg,#fff,#fbfdff);border-radius:12px;padding:12px;box-shadow:0 6px 20px rgba(20,30,60,.04);
    height:100%;
  }
  .stat{display:flex;justify-content:space-between;align-items:center;padding:8px 6px}
  .stat .label{color:var(--muted);font-size:13px}
  .stat .value{font-weight:700;font-size:15px}
  @media (max-width:900px){
    .row{grid-template-columns:1fr; }
    .controls{justify-content:space-between}
    .search input{width:140px}
  }
  @media (max-width:600px){
    .search input{width:100px}
    header .title{font-size:16px}
    .aqi{min-width:72px;padding:8px}
  }
  .loader{width:36px;height:36px;border-radius:50%;border:4px solid rgba(255,255,255,.16);border-top-color:rgba(255,255,255,.9);animation:spin 0.9s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  footer{text-align:center;padding:10px 0;color:var(--muted);font-size:13px}
</style>
</head>
<body>
<header>
  <div>
    <div class="title">ğŸŒ ÙˆØ¶Ø¹ÛŒØª Ø¢Ø¨ Ùˆ Ù‡ÙˆØ§ Ùˆ Ø¯Ù…Ø§ Ø§ÛŒØ±Ø§Ù†</div>
    <div class="subtitle">Ø¢Ù¾Ø¯ÛŒØª Ø®ÙˆØ¯Ú©Ø§Ø±: Ù‡Ø± <span id="uiInterval">60</span> Ø«Ø§Ù†ÛŒÙ‡</div>
  </div>
  <div id="installRow">
    <a href="https://eitaa.com/BGM_STUDIO" target="_blank" class="btn">Ú©Ø§Ù†Ø§Ù„ Ù…Ø§</a>
  </div>
</header>

<main>
  <div class="row">
    <div>
      <div class="controls">
        <div class="select">
          <select id="refresh" style="border:0;background:transparent;font-weight:700">
            <option value="60">Ø¢Ù¾Ø¯ÛŒØª: 60 Ø«Ø§Ù†ÛŒÙ‡</option>
            <option value="30">Ø¢Ù¾Ø¯ÛŒØª: 30 Ø«Ø§Ù†ÛŒÙ‡</option>
            <option value="120">Ø¢Ù¾Ø¯ÛŒØª: 120 Ø«Ø§Ù†ÛŒÙ‡</option>
          </select>
        </div>
        <div class="search">
          <input id="search" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ø´Ù‡Ø±..." />
        </div>
        <button class="btn ghost" id="manualRefresh">Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
      </div>
      <div class="list card-container" id="listContainer"></div>
    </div>

    <aside class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:700">Ø®Ù„Ø§ØµÙ‡ Ú©Ø´ÙˆØ±</div>
        <div style="font-size:12px;color:var(--muted)">Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: <span id="lastTime">â€”</span></div>
      </div>
      <div class="stat"><div class="label">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø¯Ù…Ø§</div><div class="value" id="avg">â€”</div></div>
      <div class="stat"><div class="label">Ø´Ù‡Ø±Ù‡Ø§</div><div class="value" id="cityCount">â€”</div></div>
    </aside>
  </div>
</main>

<footer>Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· BGM STUDIO</footer>

<script>
const cities = {
  "ØªÙ‡Ø±Ø§Ù†":[35.6892,51.3890],
  "Ù…Ø´Ù‡Ø¯":[36.2605,59.6168],
  "Ø§ØµÙÙ‡Ø§Ù†":[32.6546,51.6680],
  "Ø´ÛŒØ±Ø§Ø²":[29.5918,52.5837],
  "ØªØ¨Ø±ÛŒØ²":[38.0962,46.2738],
  "Ú©Ø±Ø¬":[35.8400,51.0000],
  "Ù‚Ù…":[34.6401,50.8764],
  "Ø§Ù‡ÙˆØ§Ø²":[31.3183,48.6706],
  "Ú©Ø±Ù…Ø§Ù†":[30.2839,57.0834],
  "ÛŒØ²Ø¯":[31.8974,54.3569],
  "Ø³Ù…Ù†Ø§Ù†":[35.5753,53.3958],
  "Ø±Ø´Øª":[37.2808,49.5832],
  "Ø§Ø±ÙˆÙ…ÛŒÙ‡":[37.5483,45.0672],
  "Ø§Ø±Ø¯Ø¨ÛŒÙ„":[38.2498,48.2933],
  "Ø²Ø§Ù‡Ø¯Ø§Ù†":[29.4963,60.8629],
  "Ø¨Ù†Ø¯Ø±Ø¹Ø¨Ø§Ø³":[27.1865,56.2808]
};

let refreshSec = Number(document.getElementById('refresh').value) || 60;
let timer = null;
const listContainer = document.getElementById('listContainer');
let previous = {};
const apiBase = "https://api.open-meteo.com/v1/forecast";

/* ØªØ¹ÛŒÛŒÙ† Ø¢ÛŒÚ©ÙˆÙ† Ù‡ÙˆØ´Ù…Ù†Ø¯ */
function weatherEmoji(temp){
  if(temp<=0) return "â„ï¸";
  if(temp<=10) return "ğŸŒ¬ï¸";
  if(temp<=20) return "â˜ï¸";
  if(temp<=30) return "ğŸŒ¤ï¸";
  return "ğŸŒ";
}

function makeCard(name,temp){
  const card = document.createElement('div');
  card.className='card';
  const left=document.createElement('div');
  left.className='left';
  const city=document.createElement('div');
  city.className='city';
  city.innerText=name;
  const meta=document.createElement('div');
  meta.className='meta';
  meta.innerText='Ù…Ø®ØªØµØ§Øª: '+(cities[name]?cities[name].join(', '):'â€”');
  left.appendChild(city);
  left.appendChild(meta);
  const box=document.createElement('div');
  box.className='aqi';
  const val=document.createElement('div');
  val.className='val';
  val.innerText=temp===null?'Ù†Ø§Ù…Ø¹ØªØ¨Ø±':temp+'Â°C';
  const emoji=document.createElement('div');
  emoji.className='emoji';
  emoji.innerText=weatherEmoji(temp);
  box.appendChild(val);
  box.appendChild(emoji);
  card.appendChild(left);
  card.appendChild(box);
  return card;
}

async function fetchTemp(lat,lon){
  try{
    const res = await fetch(`${apiBase}?latitude=${lat}&longitude=${lon}&current_weather=true`);
    const j = await res.json();
    return j?.current_weather?.temperature ?? null;
  }catch(e){return null;}
}

async function updateAll(){
  if(timer){clearTimeout(timer); timer=null;}
  listContainer.innerHTML='<div style="display:flex;justify-content:center;padding:28px"><div class="loader"></div></div>';
  const rows=[];
  for(const name of Object.keys(cities)){
    const [lat,lon]=cities[name];
    const temp = await fetchTemp(lat,lon);
    rows.push({name,temp});
    await new Promise(r=>setTimeout(r,100));
  }

  const vals=rows.filter(r=>r.temp!==null).map(r=>r.temp);
  const avg=vals.length?(vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(1):'â€”';
  document.getElementById('avg').innerText=avg;
  document.getElementById('cityCount').innerText=rows.length;
  document.getElementById('lastTime').innerText=new Date().toLocaleTimeString('fa-IR');

  listContainer.innerHTML='';
  const q=document.getElementById('search').value.trim().toLowerCase();
  for(const r of rows){
    if(q && !r.name.toLowerCase().includes(q)) continue;
    listContainer.appendChild(makeCard(r.name,r.temp));
    previous[r.name]=r.temp;
  }

  timer=setTimeout(updateAll,refreshSec*1000);
}

/* Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ */
document.getElementById('refresh').addEventListener('change',(e)=>{
  refreshSec=Number(e.target.value);
  document.getElementById('uiInterval').innerText=refreshSec;
  if(timer){clearTimeout(timer); timer=null;}
  updateAll();
});
document.getElementById('manualRefresh').addEventListener('click',()=>{if(timer){clearTimeout(timer);timer=null;}updateAll();});
document.getElementById('search').addEventListener('input',()=>{updateAll();});

/* Ø´Ø±ÙˆØ¹ */
window.addEventListener('load',updateAll);
</script>
</body>
</html>
